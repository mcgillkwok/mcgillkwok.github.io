<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—å™¨æ¢°ä¸è‰¯äº‹ä»¶æ•°æ®ç»Ÿè®¡åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .file-upload {
            border: 2px dashed #2E86AB;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #A23B72;
            background-color: #f0f2ff;
        }
        
        .file-upload input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .selector-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .selector-group h4 {
            color: #333;
            margin-right: 10px;
            line-height: 40px;
            min-width: 80px;
        }
        
        .time-btn {
            padding: 10px 20px;
            border: 2px solid #2E86AB;
            background: white;
            color: #2E86AB;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .time-btn.active {
            background: #2E86AB;
            color: white;
        }
        
        .time-btn:hover {
            background: #2E86AB;
            color: white;
        }
        
        .export-section {
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
        }
        
        .chart-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .chart-btn.active {
            background: #2E86AB;
            color: white;
            border-color: #2E86AB;
        }
        
        .chart-btn:hover {
            border-color: #2E86AB;
        }
        
        .download-btn {
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .summary-text {
            background: #f8f9fa;
            border-left: 4px solid #2E86AB;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
            color: #495057;
            line-height: 1.6;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2E86AB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åŒ»ç–—å™¨æ¢°ä¸è‰¯äº‹ä»¶æ•°æ®ç»Ÿè®¡åˆ†æç³»ç»Ÿ</h1>
            <p>æ”¯æŒExcel/CSVæ–‡ä»¶ä¸Šä¼ ï¼Œæä¾›å¤šç»´åº¦æ•°æ®ç»Ÿè®¡å’Œå¯è§†åŒ–åˆ†æ</p>
        </div>
        
        <div class="upload-section">
            <div class="file-upload" id="fileUpload">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <p style="margin-bottom: 15px; color: #666;">
                    <strong>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</strong><br>
                    æ”¯æŒ Excel (.xlsx, .xls) å’Œ CSV æ ¼å¼
                </p>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    é€‰æ‹©æ–‡ä»¶
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div class="controls" id="controls">
            <div class="selector-group">
                <h4>å¹´ä»½ç­›é€‰ï¼š</h4>
                <div id="yearButtons"></div>
            </div>
            
            <div class="selector-group">
                <h4>å­£åº¦ç­›é€‰ï¼š</h4>
                <button class="time-btn active" data-quarter="all">å…¨éƒ¨</button>
                <div id="quarterButtons"></div>
            </div>
            
            <div class="selector-group">
                <h4>æœˆä»½ç­›é€‰ï¼š</h4>
                <button class="time-btn active" data-month="all">å…¨éƒ¨</button>
                <div id="monthButtons"></div>
            </div>
            
            <div class="export-section">
                <button class="export-btn" onclick="exportToExcel()">å¯¼å‡ºExcel</button>
                <button class="export-btn" onclick="exportToCSV()">å¯¼å‡ºCSV</button>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stats-card">
                <h3>
                    æŠ¥å‘Šæƒ…å†µç»Ÿè®¡
                    <div class="chart-controls">
                        <button class="chart-btn active" data-chart="status" data-type="line">ğŸ“ˆ</button>
                        <button class="chart-btn" data-chart="status" data-type="bar">ğŸ“Š</button>
                        <button class="chart-btn" data-chart="status" data-type="pie">ğŸ¥§</button>
                        <button class="download-btn" onclick="downloadChart('statusChart')">ğŸ“Šä¸‹è½½</button>
                    </div>
                </h3>
                <div id="statusSummary" class="summary-text"></div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="stats-card">
                <h3>
                    äº§å“ç±»åˆ«ç»Ÿè®¡ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰
                    <div class="chart-controls">
                        <button class="chart-btn active" data-chart="category" data-type="line">ğŸ“ˆ</button>
                        <button class="chart-btn" data-chart="category" data-type="bar">ğŸ“Š</button>
                        <button class="chart-btn" data-chart="category" data-type="pie">ğŸ¥§</button>
                        <button class="download-btn" onclick="downloadChart('categoryChart')">ğŸ“Šä¸‹è½½</button>
                    </div>
                </h3>
                <div id="categorySummary" class="summary-text"></div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div class="stats-card">
                <h3>
                    ä¼¤å®³ç±»å‹ç»Ÿè®¡ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰
                    <div class="chart-controls">
                        <button class="chart-btn active" data-chart="injury" data-type="line">ğŸ“ˆ</button>
                        <button class="chart-btn" data-chart="injury" data-type="bar">ğŸ“Š</button>
                        <button class="chart-btn" data-chart="injury" data-type="pie">ğŸ¥§</button>
                        <button class="download-btn" onclick="downloadChart('injuryChart')">ğŸ“Šä¸‹è½½</button>
                    </div>
                </h3>
                <div id="injurySummary" class="summary-text"></div>
                <div class="chart-container">
                    <canvas id="injuryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-container" id="productTable" style="display: none;">
            <h3>äº§å“åç§°ç»Ÿè®¡æ±‡æ€»ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰</h3>
            <div class="selector-group" style="margin-bottom: 20px;">
                <button class="time-btn active" data-category="all" id="categoryAllBtn">å…¨éƒ¨</button>
                <button class="time-btn" data-category="æœ‰æº" id="categoryActiveBtn">è®¾å¤‡ï¼ˆæœ‰æºï¼‰</button>
                <button class="time-btn" data-category="æ— æº" id="categoryPassiveBtn">è€—æï¼ˆæ— æºï¼‰</button>
            </div>
            <div id="productStats"></div>
        </div>
        
        <div class="table-container" id="reporterTable" style="display: none;">
            <h3>æŠ¥å‘Šäººç»Ÿè®¡æ±‡æ€»</h3>
            <div id="reporterStats"></div>
        </div>
    </div>

    <script>
        let rawData = [];
        let processedData = {};
        let currentYear = null;
        let currentQuarter = 'all';
        let currentMonth = 'all';
        let currentCategory = 'all';
        let availableYears = [];
        let charts = {};
        let chartTypes = {
            status: 'line',
            category: 'line',
            injury: 'line'
        };
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('fileUpload').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '#f0f2ff';
        });
        document.getElementById('fileUpload').addEventListener('dragleave', (e) => {
            e.currentTarget.style.backgroundColor = '#f8f9ff';
        });
        document.getElementById('fileUpload').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '#f8f9ff';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('click', (e) => {
            if (e.target.dataset.year) {
                // å¹´ä»½åˆ‡æ¢
                document.querySelectorAll('.time-btn[data-year]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentYear = e.target.dataset.year;
                if (rawData.length > 0) {
                    processData();
                    updateAllCharts();
                }
            } else if (e.target.dataset.quarter) {
                // å­£åº¦åˆ‡æ¢
                document.querySelectorAll('.time-btn[data-quarter]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentQuarter = e.target.dataset.quarter;
                if (rawData.length > 0 && currentYear) {
                    // å¦‚æœé€‰æ‹©äº†ç‰¹å®šå­£åº¦ï¼Œæœˆä»½é‡ç½®ä¸ºå…¨éƒ¨
                    if (currentQuarter !== 'all') {
                        currentMonth = 'all';
                        document.querySelectorAll('.time-btn[data-month]').forEach(b => b.classList.remove('active'));
                        document.querySelector('.time-btn[data-month="all"]').classList.add('active');
                    }
                    processData();
                    updateAllCharts();
                }
            } else if (e.target.dataset.month) {
                // æœˆä»½åˆ‡æ¢
                document.querySelectorAll('.time-btn[data-month]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentMonth = e.target.dataset.month;
                if (rawData.length > 0 && currentYear) {
                    // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæœˆä»½ï¼Œå­£åº¦é‡ç½®ä¸ºå…¨éƒ¨
                    if (currentMonth !== 'all') {
                        currentQuarter = 'all';
                        document.querySelectorAll('.time-btn[data-quarter]').forEach(b => b.classList.remove('active'));
                        document.querySelector('.time-btn[data-quarter="all"]').classList.add('active');
                    }
                    processData();
                    updateAllCharts();
                }
            } else if (e.target.dataset.category) {
                // äº§å“ç±»åˆ«åˆ‡æ¢
                document.querySelectorAll('.time-btn[data-category]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentCategory = e.target.dataset.category;
                if (rawData.length > 0 && currentYear) {
                    updateProductTable();
                }
            } else if (e.target.dataset.chart && e.target.dataset.type) {
                // å›¾è¡¨ç±»å‹åˆ‡æ¢
                const chartName = e.target.dataset.chart;
                const chartType = e.target.dataset.type;
                
                document.querySelectorAll(`[data-chart="${chartName}"]`).forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                chartTypes[chartName] = chartType;
                updateSpecificChart(chartName);
            }
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            document.getElementById('loading').style.display = 'block';
            
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        rawData = results.data;
                        processAndDisplay();
                    },
                    error: function(error) {
                        alert('CSVæ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                        document.getElementById('loading').style.display = 'none';
                    }
                });
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        rawData = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
                        processAndDisplay();
                    } catch (error) {
                        alert('Excelæ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                        document.getElementById('loading').style.display = 'none';
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('è¯·é€‰æ‹©Excelæˆ–CSVæ–‡ä»¶');
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function processAndDisplay() {
            try {
                if (rawData.length === 0) {
                    alert('æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
                    return;
                }
                
                // æå–å¯ç”¨å¹´ä»½
                extractAvailableYears();
                
                // ç”Ÿæˆå¹´ä»½ç­›é€‰æŒ‰é’®
                generateYearButtons();
                
                // ç”Ÿæˆå­£åº¦å’Œæœˆä»½æŒ‰é’®
                generateQuarterButtons();
                generateMonthButtons();
                
                // è®¾ç½®é»˜è®¤å¹´ä»½ï¼ˆæœ€æ–°å¹´ä»½ï¼‰
                currentYear = availableYears[availableYears.length - 1];
                document.querySelector(`[data-year="${currentYear}"]`).classList.add('active');
                
                processData();
                updateAllCharts();
                
                document.getElementById('controls').style.display = 'block';
                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('productTable').style.display = 'block';
                document.getElementById('reporterTable').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('æ•°æ®å¤„ç†é”™è¯¯:', error);
                alert('æ•°æ®å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function extractAvailableYears() {
            const years = new Set();
            rawData.forEach(row => {
                const date = parseDate(row['æŠ¥å‘Šæ—¥æœŸ']);
                if (date) {
                    years.add(date.getFullYear());
                }
            });
            availableYears = Array.from(years).sort((a, b) => a - b);
        }
        
        function generateYearButtons() {
            const yearButtonsContainer = document.getElementById('yearButtons');
            yearButtonsContainer.innerHTML = '';
            
            availableYears.forEach(year => {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                btn.dataset.year = year.toString();
                btn.textContent = year + 'å¹´';
                yearButtonsContainer.appendChild(btn);
            });
        }
        
        function generateQuarterButtons() {
            const quarterButtonsContainer = document.getElementById('quarterButtons');
            quarterButtonsContainer.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                btn.dataset.quarter = `Q${i}`;
                btn.textContent = `Q${i}`;
                quarterButtonsContainer.appendChild(btn);
            }
        }
        
        function generateMonthButtons() {
            const monthButtonsContainer = document.getElementById('monthButtons');
            monthButtonsContainer.innerHTML = '';
            
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                btn.dataset.month = i.toString();
                btn.textContent = i + 'æœˆ';
                monthButtonsContainer.appendChild(btn);
            }
        }
        
        function processData() {
            if (!currentYear) return;
            
            processedData = {
                status: {},
                category: {},
                injury: {},
                reporter: {},
                product: {
                    all: {},
                    æœ‰æº: {},
                    æ— æº: {}
                }
            };
            
            // ç­›é€‰å½“å‰å¹´ä»½çš„æ•°æ®
            let filteredData = rawData.filter(row => {
                const date = parseDate(row['æŠ¥å‘Šæ—¥æœŸ']);
                return date && date.getFullYear().toString() === currentYear.toString();
            });
            
            // è¿›ä¸€æ­¥æ ¹æ®å­£åº¦æˆ–æœˆä»½ç­›é€‰
            if (currentQuarter !== 'all') {
                filteredData = filteredData.filter(row => {
                    const date = parseDate(row['æŠ¥å‘Šæ—¥æœŸ']);
                    if (!date) return false;
                    const quarter = Math.ceil((date.getMonth() + 1) / 3);
                    return `Q${quarter}` === currentQuarter;
                });
            } else if (currentMonth !== 'all') {
                filteredData = filteredData.filter(row => {
                    const date = parseDate(row['æŠ¥å‘Šæ—¥æœŸ']);
                    if (!date) return false;
                    return (date.getMonth() + 1).toString() === currentMonth;
                });
            }
            
            // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶å†³å®šæ•°æ®åˆ†ç»„æ–¹å¼
            let groupBy = 'month'; // é»˜è®¤æŒ‰æœˆåˆ†ç»„
            if (currentQuarter !== 'all') {
                groupBy = 'month'; // é€‰æ‹©ç‰¹å®šå­£åº¦æ—¶æŒ‰æœˆåˆ†ç»„
            } else if (currentMonth !== 'all') {
                groupBy = 'day'; // é€‰æ‹©ç‰¹å®šæœˆä»½æ—¶æŒ‰æ—¥åˆ†ç»„
            } else {
                groupBy = 'quarter'; // å…¨å¹´æ—¶æŒ‰å­£åº¦åˆ†ç»„
            }
            
            filteredData.forEach(row => {
                const date = parseDate(row['æŠ¥å‘Šæ—¥æœŸ']);
                if (!date) return;
                
                const period = getPeriodKey(date, groupBy);
                const status = (row['ç»è¥ä¼ä¸šä½¿ç”¨å•ä½æŠ¥å‘ŠçŠ¶æ€'] || '').toString().trim();
                const category = (row['äº§å“ç±»åˆ«'] || '').toString().trim();
                const injury = (row['ä¼¤å®³'] || '').toString().trim();
                const reporter = (row['æŠ¥å‘Šäºº'] || '').toString().trim();
                const product = (row['äº§å“åç§°'] || '').toString().trim();
                
                // 1. çŠ¶æ€ç»Ÿè®¡
                if (!processedData.status[period]) processedData.status[period] = {};
                if (status) {
                    if (!processedData.status[period][status]) processedData.status[period][status] = 0;
                    processedData.status[period][status]++;
                }
                
                // 2. äº§å“ç±»åˆ«ç»Ÿè®¡ï¼ˆä»…å®¡æ ¸é€šè¿‡ï¼‰
                if (status === 'å®¡æ ¸é€šè¿‡' && category) {
                    if (!processedData.category[period]) processedData.category[period] = {};
                    if (!processedData.category[period][category]) processedData.category[period][category] = 0;
                    processedData.category[period][category]++;
                }
                
                // 3. ä¼¤å®³ç»Ÿè®¡ï¼ˆä»…å®¡æ ¸é€šè¿‡ï¼‰
                if (status === 'å®¡æ ¸é€šè¿‡' && injury) {
                    if (!processedData.injury[period]) processedData.injury[period] = {};
                    if (!processedData.injury[period][injury]) processedData.injury[period][injury] = 0;
                    processedData.injury[period][injury]++;
                }
                
                // 4. æŠ¥å‘Šäººç»Ÿè®¡
                if (reporter) {
                    if (!processedData.reporter[reporter]) processedData.reporter[reporter] = 0;
                    processedData.reporter[reporter]++;
                }
                
                // 5. äº§å“åç§°ç»Ÿè®¡ï¼ˆä»…å®¡æ ¸é€šè¿‡ï¼‰
                if (status === 'å®¡æ ¸é€šè¿‡' && product) {
                    if (!processedData.product.all[product]) processedData.product.all[product] = 0;
                    processedData.product.all[product]++;
                    
                    if (category === 'æœ‰æº' || category === 'æ— æº') {
                        if (!processedData.product[category][product]) processedData.product[category][product] = 0;
                        processedData.product[category][product]++;
                    }
                }
            });
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const str = dateStr.toString().trim();
            
            const formats = [
                /(\d{4})-(\d{1,2})-(\d{1,2})/,
                /(\d{4})\/(\d{1,2})\/(\d{1,2})/,
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
            ];
            
            for (let format of formats) {
                const match = str.match(format);
                if (match) {
                    let year, month, day;
                    if (format === formats[2]) {
                        month = parseInt(match[1]);
                        day = parseInt(match[2]);
                        year = parseInt(match[3]);
                    } else {
                        year = parseInt(match[1]);
                        month = parseInt(match[2]);
                        day = parseInt(match[3]);
                    }
                    
                    const date = new Date(year, month - 1, day);
                    if (date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day) {
                        return date;
                    }
                }
            }
            return null;
        }
        
        function getPeriodKey(date, groupBy) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            switch(groupBy) {
                case 'month':
                    return `${month}æœˆ`;
                case 'quarter':
                    const quarter = Math.ceil(month / 3);
                    return `Q${quarter}`;
                case 'day':
                    return `${month}/${day}`;
                default:
                    return `${month}æœˆ`;
            }
        }
        
        function updateAllCharts() {
            updateStatusChart();
            updateCategoryChart();
            updateInjuryChart();
            updateReporterTable();
            updateProductTable();
        }
        
        function updateSpecificChart(chartName) {
            switch(chartName) {
                case 'status':
                    updateStatusChart();
                    break;
                case 'category':
                    updateCategoryChart();
                    break;
                case 'injury':
                    updateInjuryChart();
                    break;
            }
        }
        
        function createChart(ctx, type, data, options = {}) {
            const chartId = ctx.canvas.id;
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            
            // è®¾ç½®åŒ»ç–—ä¸“ä¸šé…è‰²
            const colors = {
                primary: '#2E86AB',
                secondary: '#A23B72',
                success: '#28A745',
                warning: '#FFC107',
                danger: '#DC3545',
                info: '#17A2B8'
            };
            
            // ä¸ºæ•°æ®æ·»åŠ åŒ»ç–—é£æ ¼æ¸å˜è‰²
            if (data.datasets) {
                data.datasets.forEach((dataset, index) => {
                    if (!dataset.backgroundColor) {
                        const colorKeys = Object.keys(colors);
                        const baseColor = colors[colorKeys[index % colorKeys.length]];
                        dataset.backgroundColor = baseColor;
                        dataset.borderColor = baseColor;
                        
                        if (type === 'line') {
                            dataset.backgroundColor = baseColor + '20'; // é€æ˜åº¦
                            dataset.fill = false;
                            dataset.tension = 0.4;
                        }
                    }
                });
            }
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: type === 'pie' ? 'bottom' : 'top',
                    }
                },
                scales: type === 'pie' ? {} : {
                    y: {
                        beginAtZero: true,
                        grace: '15%', // Yè½´é¡¶éƒ¨ç•™ç™½
                        grid: {
                            color: '#e9ecef',
                            lineWidth: 1
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };
            
            charts[chartId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {...defaultOptions, ...options},
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        if (type === 'pie') return; // é¥¼å›¾ä¸éœ€è¦æ•°å€¼æ ‡ç­¾
                        
                        const ctx = chart.ctx;
                        ctx.save();
                        
                        chart.data.datasets.forEach(function(dataset, datasetIndex) {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            if (!meta.hidden) {
                                meta.data.forEach(function(element, index) {
                                    const value = dataset.data[index];
                                    if (value === 0) return;
                                    
                                    ctx.fillStyle = '#333';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    
                                    const position = element.tooltipPosition();
                                    
                                    // æ™ºèƒ½æ ‡ç­¾å®šä½ - ç»Ÿä¸€å¤–ç½®æ ‡ç­¾
                                    if (chart.config.options.indexAxis === 'y') {
                                        // æ°´å¹³æ¡å½¢å›¾ - æ ‡ç­¾æ˜¾ç¤ºåœ¨æ¡å½¢å³ä¾§
                                        ctx.textAlign = 'left';
                                        ctx.fillText(value.toString(), position.x + 8, position.y);
                                    } else {
                                        // å‚ç›´æŸ±çŠ¶å›¾/æŠ˜çº¿å›¾ - æ ‡ç­¾æ˜¾ç¤ºåœ¨æŸ±å­ä¸Šæ–¹
                                        ctx.fillText(value.toString(), position.x, position.y - 8);
                                    }
                                });
                            }
                        });
                        
                        ctx.restore();
                    }
                }]
            });
        }
        
        function generateSummaryText() {
            if (!currentYear) return '';
            
            // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶ç”Ÿæˆå¯¹åº”çš„å°ç»“æ–‡å­—
            let periodText = `${currentYear}å¹´`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}å­£åº¦`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}æœˆ`;
            } else {
                periodText += 'å…¨å¹´';
            }
            
            // è®¡ç®—å½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ€»æ•°å’Œå„é¡¹ç»Ÿè®¡
            let totalReports = 0;
            let approvedReports = 0;
            let deviceReports = 0;
            let consumableReports = 0;
            let severeInjuryReports = 0;
            
            // ç»Ÿè®¡å½“å‰ç­›é€‰æ•°æ®
            const statusData = processedData.status;
            const periods = Object.keys(statusData);
            
            periods.forEach(period => {
                Object.keys(statusData[period]).forEach(status => {
                    totalReports += statusData[period][status];
                    if (status === 'å®¡æ ¸é€šè¿‡') {
                        approvedReports += statusData[period][status];
                    }
                });
            });
            
            // è®¡ç®—äº§å“ç±»åˆ«
            const categoryData = processedData.category;
            Object.keys(categoryData).forEach(period => {
                deviceReports += categoryData[period]['æœ‰æº'] || 0;
                consumableReports += categoryData[period]['æ— æº'] || 0;
            });
            
            // è®¡ç®—ä¸¥é‡ä¼¤å®³
            const injuryData = processedData.injury;
            Object.keys(injuryData).forEach(period => {
                severeInjuryReports += injuryData[period]['ä¸¥é‡ä¼¤å®³'] || 0;
            });
            
            const approvedRate = totalReports > 0 ? ((approvedReports / totalReports) * 100).toFixed(1) : 0;
            const deviceRate = approvedReports > 0 ? ((deviceReports / approvedReports) * 100).toFixed(1) : 0;
            const consumableRate = approvedReports > 0 ? ((consumableReports / approvedReports) * 100).toFixed(1) : 0;
            const severeRate = approvedReports > 0 ? ((severeInjuryReports / approvedReports) * 100).toFixed(1) : 0;
            
            return `${periodText}å…±ä¸ŠæŠ¥åŒ»ç–—å™¨æ¢°ä¸è‰¯äº‹ä»¶æŠ¥å‘Š${totalReports}æ¡ï¼Œå…¶ä¸­å®¡æ ¸é€šè¿‡${approvedReports}æ¡ï¼ˆå ${approvedRate}%ï¼‰ï¼Œå®¡æ ¸é€šè¿‡çš„æŠ¥å‘Šä¸­ï¼Œè®¾å¤‡ï¼ˆæœ‰æºåŒ»ç–—å™¨æ¢°ï¼‰æŠ¥å‘Š${deviceReports}æ¡ï¼ˆå ${deviceRate}%ï¼‰ï¼Œè€—æï¼ˆæ— æºåŒ»ç–—å™¨æ¢°ï¼‰æŠ¥å‘Š${consumableReports}æ¡ï¼ˆå ${consumableRate}%ï¼‰ï¼Œä¸¥é‡ä¼¤å®³æŠ¥å‘Š${severeInjuryReports}æ¡ï¼ˆå ${severeRate}%ï¼‰ã€‚`;
        }
        
        function updateStatusChart() {
            const data = processedData.status;
            const periods = Object.keys(data).sort();
            
            if (periods.length === 0) return;
            
            const statusTypes = new Set();
            periods.forEach(p => {
                Object.keys(data[p] || {}).forEach(s => statusTypes.add(s));
            });
            
            const datasets = Array.from(statusTypes).map((status, index) => ({
                label: status,
                data: periods.map(p => (data[p] && data[p][status]) || 0),
            }));
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            const chartType = chartTypes.status;
            
            let chartData;
            if (chartType === 'pie') {
                // é¥¼å›¾æ˜¾ç¤ºæ€»è®¡æ•°æ®
                const totals = {};
                statusTypes.forEach(status => {
                    totals[status] = periods.reduce((sum, p) => sum + ((data[p] && data[p][status]) || 0), 0);
                });
                
                chartData = {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#28A745', '#DC3545', '#FFC107', '#17A2B8']
                    }]
                };
            } else {
                chartData = {
                    labels: periods,
                    datasets: datasets
                };
            }
            
            createChart(ctx, chartType, chartData);
            
            // æ›´æ–°å°ç»“æ–‡å­—
            document.getElementById('statusSummary').innerHTML = generateSummaryText();
        }
        
        function updateCategoryChart() {
            const data = processedData.category;
            const periods = Object.keys(data).sort();
            
            if (periods.length === 0) {
                document.getElementById('categorySummary').innerHTML = 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— å®¡æ ¸é€šè¿‡çš„æ•°æ®';
                return;
            }
            
            const categoryTypes = new Set();
            periods.forEach(p => {
                Object.keys(data[p] || {}).forEach(c => categoryTypes.add(c));
            });
            
            const datasets = Array.from(categoryTypes).map((category) => ({
                label: category === 'æœ‰æº' ? 'è®¾å¤‡ï¼ˆæœ‰æºï¼‰' : 'è€—æï¼ˆæ— æºï¼‰',
                data: periods.map(p => (data[p] && data[p][category]) || 0),
            }));
            
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const chartType = chartTypes.category;
            
            let chartData;
            if (chartType === 'pie') {
                const totals = {};
                categoryTypes.forEach(category => {
                    const label = category === 'æœ‰æº' ? 'è®¾å¤‡ï¼ˆæœ‰æºï¼‰' : 'è€—æï¼ˆæ— æºï¼‰';
                    totals[label] = periods.reduce((sum, p) => sum + ((data[p] && data[p][category]) || 0), 0);
                });
                
                chartData = {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#17A2B8', '#FFC107']
                    }]
                };
            } else {
                chartData = {
                    labels: periods,
                    datasets: datasets
                };
            }
            
            createChart(ctx, chartType, chartData);
            
            document.getElementById('categorySummary').innerHTML = generateSummaryText();
        }
        
        function updateInjuryChart() {
            const data = processedData.injury;
            const periods = Object.keys(data).sort();
            
            if (periods.length === 0) {
                document.getElementById('injurySummary').innerHTML = 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— å®¡æ ¸é€šè¿‡çš„æ•°æ®';
                return;
            }
            
            const injuryTypes = new Set();
            periods.forEach(p => {
                Object.keys(data[p] || {}).forEach(i => injuryTypes.add(i));
            });
            
            const datasets = Array.from(injuryTypes).map((injury) => ({
                label: injury,
                data: periods.map(p => (data[p] && data[p][injury]) || 0),
            }));
            
            const ctx = document.getElementById('injuryChart').getContext('2d');
            const chartType = chartTypes.injury;
            
            let chartData;
            if (chartType === 'pie') {
                const totals = {};
                injuryTypes.forEach(injury => {
                    totals[injury] = periods.reduce((sum, p) => sum + ((data[p] && data[p][injury]) || 0), 0);
                });
                
                chartData = {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#FD7E14', '#E83E8C', '#6610F2', '#20C997']
                    }]
                };
            } else {
                chartData = {
                    labels: periods,
                    datasets: datasets
                };
            }
            
            createChart(ctx, chartType, chartData);
            
            document.getElementById('injurySummary').innerHTML = generateSummaryText();
        }
        
        function updateReporterTable() {
            const data = processedData.reporter;
            const reporters = Object.entries(data)
                .sort((a, b) => b[1] - a[1]);
            
            let periodText = `${currentYear}å¹´`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}å­£åº¦`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}æœˆ`;
            } else {
                periodText += 'å…¨å¹´';
            }
            
            let tableHtml = `
                <div style="margin-bottom: 15px;">
                    <strong>${periodText}æŠ¥å‘Šäººç»Ÿè®¡ï¼š</strong>å…± ${reporters.length} ä¸ªæŠ¥å‘Šäººï¼Œæ€»è®¡ ${reporters.reduce((sum, r) => sum + r[1], 0)} æ¡æŠ¥å‘Š
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>æŠ¥å‘Šäºº</th>
                            <th>æŠ¥å‘Šæ•°é‡</th>
                            <th>å æ¯”</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const total = reporters.reduce((sum, r) => sum + r[1], 0);
            if (reporters.length > 0) {
                reporters.forEach((reporter, index) => {
                    const percentage = ((reporter[1] / total) * 100).toFixed(2);
                    tableHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${reporter[0]}</td>
                            <td>${reporter[1]}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            } else {
                tableHtml += `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— æ•°æ®</td>
                    </tr>
                `;
            }
            
            tableHtml += '</tbody></table>';
            document.getElementById('reporterStats').innerHTML = tableHtml;
        }
        
        function updateProductTable() {
            const data = processedData.product[currentCategory];
            const products = Object.entries(data)
                .sort((a, b) => b[1] - a[1]);
            
            let categoryTitle = '';
            switch(currentCategory) {
                case 'all': categoryTitle = 'å…¨éƒ¨äº§å“'; break;
                case 'æœ‰æº': categoryTitle = 'è®¾å¤‡ï¼ˆæœ‰æºï¼‰'; break;
                case 'æ— æº': categoryTitle = 'è€—æï¼ˆæ— æºï¼‰'; break;
            }
            
            let periodText = `${currentYear}å¹´`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}å­£åº¦`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}æœˆ`;
            } else {
                periodText += 'å…¨å¹´';
            }
            
            let tableHtml = `
                <div style="margin-bottom: 15px;">
                    <strong>${categoryTitle}ç»Ÿè®¡ï¼ˆ${periodText}ï¼‰ï¼š</strong>å…± ${products.length} ç§äº§å“ï¼Œæ€»è®¡ ${products.reduce((sum, p) => sum + p[1], 0)} æ¡æŠ¥å‘Š
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>äº§å“åç§°</th>
                            <th>æŠ¥å‘Šæ•°é‡</th>
                            <th>å æ¯”</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const total = products.reduce((sum, p) => sum + p[1], 0);
            if (total > 0) {
                products.forEach((product, index) => {
                    const percentage = ((product[1] / total) * 100).toFixed(2);
                    tableHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product[0]}</td>
                            <td>${product[1]}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            } else {
                tableHtml += `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æš‚æ— ${categoryTitle}æ•°æ®</td>
                    </tr>
                `;
            }
            
            tableHtml += '</tbody></table>';
            document.getElementById('productStats').innerHTML = tableHtml;
        }
        
        function downloadChart(chartId) {
            const chart = charts[chartId];
            if (!chart) {
                alert('å›¾è¡¨æœªæ‰¾åˆ°');
                return;
            }
            
            // åˆ›å»ºä¸‹è½½é€‰é¡¹
            const options = [
                { format: 'png', label: 'PNGé«˜æ¸…å›¾ç‰‡' },
                { format: 'pdf', label: 'PDFçŸ¢é‡å›¾' },
                { format: 'jpg', label: 'JPGå‹ç¼©å›¾ç‰‡' }
            ];
            
            const selection = prompt('è¯·é€‰æ‹©ä¸‹è½½æ ¼å¼ï¼š\n1. PNGé«˜æ¸…å›¾ç‰‡\n2. PDFçŸ¢é‡å›¾\n3. JPGå‹ç¼©å›¾ç‰‡\n\nè¯·è¾“å…¥æ•°å­— 1-3ï¼š');
            
            if (!selection || selection < 1 || selection > 3) return;
            
            const selectedOption = options[selection - 1];
            const canvas = chart.canvas;
            
            if (selectedOption.format === 'png') {
                const url = canvas.toDataURL('image/png');
                downloadFile(url, `${chartId}_${currentYear}å¹´_${new Date().getTime()}.png`);
            } else if (selectedOption.format === 'jpg') {
                const url = canvas.toDataURL('image/jpeg', 0.9);
                downloadFile(url, `${chartId}_${currentYear}å¹´_${new Date().getTime()}.jpg`);
            } else if (selectedOption.format === 'pdf') {
                // ç®€åŒ–ç‰ˆPDFä¸‹è½½ï¼ˆå®é™…ä¸ºPNGæ ¼å¼ï¼‰
                const url = canvas.toDataURL('image/png');
                downloadFile(url, `${chartId}_${currentYear}å¹´_${new Date().getTime()}.png`);
                alert('PDFæ ¼å¼ä¸‹è½½åŠŸèƒ½å¼€å‘ä¸­ï¼Œå·²ä¸ºæ‚¨ä¸‹è½½PNGæ ¼å¼');
            }
        }
        
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportToExcel() {
            if (rawData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // åŸå§‹æ•°æ®
            const ws1 = XLSX.utils.json_to_sheet(rawData);
            XLSX.utils.book_append_sheet(wb, ws1, "åŸå§‹æ•°æ®");
            
            // ç»Ÿè®¡æ±‡æ€»
            let periodText = `${currentYear}å¹´`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}å­£åº¦`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}æœˆ`;
            } else {
                periodText += 'å…¨å¹´';
            }
            
            const summaryData = [
                ['ç»Ÿè®¡é¡¹ç›®', 'æ•°å€¼'],
                ['åˆ†ææ—¶é—´', periodText],
                ['æ•°æ®æ€»æ¡æ•°', rawData.length],
                ['æŠ¥å‘Šäººæ€»æ•°', Object.keys(processedData.reporter).length],
                ['äº§å“ç§ç±»', Object.keys(processedData.product.all).length]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, "ç»Ÿè®¡æ±‡æ€»");
            
            XLSX.writeFile(wb, `åŒ»ç–—å™¨æ¢°ä¸è‰¯äº‹ä»¶ç»Ÿè®¡åˆ†æ_${periodText}_${new Date().getTime()}.xlsx`);
        }
        
        function exportToCSV() {
            if (rawData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }
            
            const csv = Papa.unparse(rawData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            let periodText = `${currentYear}å¹´`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}å­£åº¦`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}æœˆ`;
            } else {
                periodText += 'å…¨å¹´';
            }
            
            link.setAttribute('download', `åŒ»ç–—å™¨æ¢°ä¸è‰¯äº‹ä»¶æ•°æ®_${periodText}_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
