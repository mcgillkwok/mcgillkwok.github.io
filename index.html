<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医疗器械不良事件数据统计分析系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .file-upload {
            border: 2px dashed #2E86AB;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: #A23B72;
            background-color: #f0f2ff;
        }
        
        .file-upload input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .selector-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .selector-group h4 {
            color: #333;
            margin-right: 10px;
            line-height: 40px;
            min-width: 80px;
        }
        
        .time-btn {
            padding: 10px 20px;
            border: 2px solid #2E86AB;
            background: white;
            color: #2E86AB;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .time-btn.active {
            background: #2E86AB;
            color: white;
        }
        
        .time-btn:hover {
            background: #2E86AB;
            color: white;
        }
        
        .export-section {
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-controls {
            display: flex;
            gap: 8px;
        }
        
        .chart-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .chart-btn.active {
            background: #2E86AB;
            color: white;
            border-color: #2E86AB;
        }
        
        .chart-btn:hover {
            border-color: #2E86AB;
        }
        
        .download-btn {
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .summary-text {
            background: #f8f9fa;
            border-left: 4px solid #2E86AB;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 6px 6px 0;
            color: #495057;
            line-height: 1.6;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }
        
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2E86AB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>医疗器械不良事件数据统计分析系统</h1>
            <p>支持Excel/CSV文件上传，提供多维度数据统计和可视化分析</p>
        </div>
        
        <div class="upload-section">
            <div class="file-upload" id="fileUpload">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <p style="margin-bottom: 15px; color: #666;">
                    <strong>点击选择文件或拖拽文件到此处</strong><br>
                    支持 Excel (.xlsx, .xls) 和 CSV 格式
                </p>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    选择文件
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>正在处理数据，请稍候...</p>
        </div>
        
        <div class="controls" id="controls">
            <div class="selector-group">
                <h4>年份筛选：</h4>
                <div id="yearButtons"></div>
            </div>
            
            <div class="selector-group">
                <h4>季度筛选：</h4>
                <button class="time-btn active" data-quarter="all">全部</button>
                <div id="quarterButtons"></div>
            </div>
            
            <div class="selector-group">
                <h4>月份筛选：</h4>
                <button class="time-btn active" data-month="all">全部</button>
                <div id="monthButtons"></div>
            </div>
            
            <div class="export-section">
                <button class="export-btn" onclick="exportToExcel()">导出Excel</button>
                <button class="export-btn" onclick="exportToCSV()">导出CSV</button>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stats-card">
                <h3>
                    报告情况统计
                    <div class="chart-controls">
                        <button class="chart-btn active" data-chart="status" data-type="line">📈</button>
                        <button class="chart-btn" data-chart="status" data-type="bar">📊</button>
                        <button class="chart-btn" data-chart="status" data-type="pie">🥧</button>
                        <button class="download-btn" onclick="downloadChart('statusChart')">📊下载</button>
                    </div>
                </h3>
                <div id="statusSummary" class="summary-text"></div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="stats-card">
                <h3>
                    产品类别统计（审核通过）
                    <div class="chart-controls">
                        <button class="chart-btn active" data-chart="category" data-type="line">📈</button>
                        <button class="chart-btn" data-chart="category" data-type="bar">📊</button>
                        <button class="chart-btn" data-chart="category" data-type="pie">🥧</button>
                        <button class="download-btn" onclick="downloadChart('categoryChart')">📊下载</button>
                    </div>
                </h3>
                <div id="categorySummary" class="summary-text"></div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div class="stats-card">
                <h3>
                    伤害类型统计（审核通过）
                    <div class="chart-controls">
                        <button class="chart-btn active" data-chart="injury" data-type="line">📈</button>
                        <button class="chart-btn" data-chart="injury" data-type="bar">📊</button>
                        <button class="chart-btn" data-chart="injury" data-type="pie">🥧</button>
                        <button class="download-btn" onclick="downloadChart('injuryChart')">📊下载</button>
                    </div>
                </h3>
                <div id="injurySummary" class="summary-text"></div>
                <div class="chart-container">
                    <canvas id="injuryChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-container" id="productTable" style="display: none;">
            <h3>产品名称统计汇总（审核通过）</h3>
            <div class="selector-group" style="margin-bottom: 20px;">
                <button class="time-btn active" data-category="all" id="categoryAllBtn">全部</button>
                <button class="time-btn" data-category="有源" id="categoryActiveBtn">设备（有源）</button>
                <button class="time-btn" data-category="无源" id="categoryPassiveBtn">耗材（无源）</button>
            </div>
            <div id="productStats"></div>
        </div>
        
        <div class="table-container" id="reporterTable" style="display: none;">
            <h3>报告人统计汇总</h3>
            <div id="reporterStats"></div>
        </div>
    </div>

    <script>
        let rawData = [];
        let processedData = {};
        let currentYear = null;
        let currentQuarter = 'all';
        let currentMonth = 'all';
        let currentCategory = 'all';
        let availableYears = [];
        let charts = {};
        let chartTypes = {
            status: 'line',
            category: 'line',
            injury: 'line'
        };
        
        // 文件上传处理
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('fileUpload').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '#f0f2ff';
        });
        document.getElementById('fileUpload').addEventListener('dragleave', (e) => {
            e.currentTarget.style.backgroundColor = '#f8f9ff';
        });
        document.getElementById('fileUpload').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.style.backgroundColor = '#f8f9ff';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // 事件监听器
        document.addEventListener('click', (e) => {
            if (e.target.dataset.year) {
                // 年份切换
                document.querySelectorAll('.time-btn[data-year]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentYear = e.target.dataset.year;
                if (rawData.length > 0) {
                    processData();
                    updateAllCharts();
                }
            } else if (e.target.dataset.quarter) {
                // 季度切换
                document.querySelectorAll('.time-btn[data-quarter]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentQuarter = e.target.dataset.quarter;
                if (rawData.length > 0 && currentYear) {
                    // 如果选择了特定季度，月份重置为全部
                    if (currentQuarter !== 'all') {
                        currentMonth = 'all';
                        document.querySelectorAll('.time-btn[data-month]').forEach(b => b.classList.remove('active'));
                        document.querySelector('.time-btn[data-month="all"]').classList.add('active');
                    }
                    processData();
                    updateAllCharts();
                }
            } else if (e.target.dataset.month) {
                // 月份切换
                document.querySelectorAll('.time-btn[data-month]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentMonth = e.target.dataset.month;
                if (rawData.length > 0 && currentYear) {
                    // 如果选择了特定月份，季度重置为全部
                    if (currentMonth !== 'all') {
                        currentQuarter = 'all';
                        document.querySelectorAll('.time-btn[data-quarter]').forEach(b => b.classList.remove('active'));
                        document.querySelector('.time-btn[data-quarter="all"]').classList.add('active');
                    }
                    processData();
                    updateAllCharts();
                }
            } else if (e.target.dataset.category) {
                // 产品类别切换
                document.querySelectorAll('.time-btn[data-category]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentCategory = e.target.dataset.category;
                if (rawData.length > 0 && currentYear) {
                    updateProductTable();
                }
            } else if (e.target.dataset.chart && e.target.dataset.type) {
                // 图表类型切换
                const chartName = e.target.dataset.chart;
                const chartType = e.target.dataset.type;
                
                document.querySelectorAll(`[data-chart="${chartName}"]`).forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                chartTypes[chartName] = chartType;
                updateSpecificChart(chartName);
            }
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            document.getElementById('loading').style.display = 'block';
            
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        rawData = results.data;
                        processAndDisplay();
                    },
                    error: function(error) {
                        alert('CSV文件解析失败: ' + error.message);
                        document.getElementById('loading').style.display = 'none';
                    }
                });
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        rawData = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
                        processAndDisplay();
                    } catch (error) {
                        alert('Excel文件解析失败: ' + error.message);
                        document.getElementById('loading').style.display = 'none';
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert('请选择Excel或CSV文件');
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function processAndDisplay() {
            try {
                if (rawData.length === 0) {
                    alert('文件中没有找到有效数据');
                    return;
                }
                
                // 提取可用年份
                extractAvailableYears();
                
                // 生成年份筛选按钮
                generateYearButtons();
                
                // 生成季度和月份按钮
                generateQuarterButtons();
                generateMonthButtons();
                
                // 设置默认年份（最新年份）
                currentYear = availableYears[availableYears.length - 1];
                document.querySelector(`[data-year="${currentYear}"]`).classList.add('active');
                
                processData();
                updateAllCharts();
                
                document.getElementById('controls').style.display = 'block';
                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('productTable').style.display = 'block';
                document.getElementById('reporterTable').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('数据处理错误:', error);
                alert('数据处理失败，请检查文件格式是否正确');
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function extractAvailableYears() {
            const years = new Set();
            rawData.forEach(row => {
                const date = parseDate(row['报告日期']);
                if (date) {
                    years.add(date.getFullYear());
                }
            });
            availableYears = Array.from(years).sort((a, b) => a - b);
        }
        
        function generateYearButtons() {
            const yearButtonsContainer = document.getElementById('yearButtons');
            yearButtonsContainer.innerHTML = '';
            
            availableYears.forEach(year => {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                btn.dataset.year = year.toString();
                btn.textContent = year + '年';
                yearButtonsContainer.appendChild(btn);
            });
        }
        
        function generateQuarterButtons() {
            const quarterButtonsContainer = document.getElementById('quarterButtons');
            quarterButtonsContainer.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                btn.dataset.quarter = `Q${i}`;
                btn.textContent = `Q${i}`;
                quarterButtonsContainer.appendChild(btn);
            }
        }
        
        function generateMonthButtons() {
            const monthButtonsContainer = document.getElementById('monthButtons');
            monthButtonsContainer.innerHTML = '';
            
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                btn.className = 'time-btn';
                btn.dataset.month = i.toString();
                btn.textContent = i + '月';
                monthButtonsContainer.appendChild(btn);
            }
        }
        
        function processData() {
            if (!currentYear) return;
            
            processedData = {
                status: {},
                category: {},
                injury: {},
                reporter: {},
                product: {
                    all: {},
                    有源: {},
                    无源: {}
                }
            };
            
            // 筛选当前年份的数据
            let filteredData = rawData.filter(row => {
                const date = parseDate(row['报告日期']);
                return date && date.getFullYear().toString() === currentYear.toString();
            });
            
            // 进一步根据季度或月份筛选
            if (currentQuarter !== 'all') {
                filteredData = filteredData.filter(row => {
                    const date = parseDate(row['报告日期']);
                    if (!date) return false;
                    const quarter = Math.ceil((date.getMonth() + 1) / 3);
                    return `Q${quarter}` === currentQuarter;
                });
            } else if (currentMonth !== 'all') {
                filteredData = filteredData.filter(row => {
                    const date = parseDate(row['报告日期']);
                    if (!date) return false;
                    return (date.getMonth() + 1).toString() === currentMonth;
                });
            }
            
            // 根据当前筛选条件决定数据分组方式
            let groupBy = 'month'; // 默认按月分组
            if (currentQuarter !== 'all') {
                groupBy = 'month'; // 选择特定季度时按月分组
            } else if (currentMonth !== 'all') {
                groupBy = 'day'; // 选择特定月份时按日分组
            } else {
                groupBy = 'quarter'; // 全年时按季度分组
            }
            
            filteredData.forEach(row => {
                const date = parseDate(row['报告日期']);
                if (!date) return;
                
                const period = getPeriodKey(date, groupBy);
                const status = (row['经营企业使用单位报告状态'] || '').toString().trim();
                const category = (row['产品类别'] || '').toString().trim();
                const injury = (row['伤害'] || '').toString().trim();
                const reporter = (row['报告人'] || '').toString().trim();
                const product = (row['产品名称'] || '').toString().trim();
                
                // 1. 状态统计
                if (!processedData.status[period]) processedData.status[period] = {};
                if (status) {
                    if (!processedData.status[period][status]) processedData.status[period][status] = 0;
                    processedData.status[period][status]++;
                }
                
                // 2. 产品类别统计（仅审核通过）
                if (status === '审核通过' && category) {
                    if (!processedData.category[period]) processedData.category[period] = {};
                    if (!processedData.category[period][category]) processedData.category[period][category] = 0;
                    processedData.category[period][category]++;
                }
                
                // 3. 伤害统计（仅审核通过）
                if (status === '审核通过' && injury) {
                    if (!processedData.injury[period]) processedData.injury[period] = {};
                    if (!processedData.injury[period][injury]) processedData.injury[period][injury] = 0;
                    processedData.injury[period][injury]++;
                }
                
                // 4. 报告人统计
                if (reporter) {
                    if (!processedData.reporter[reporter]) processedData.reporter[reporter] = 0;
                    processedData.reporter[reporter]++;
                }
                
                // 5. 产品名称统计（仅审核通过）
                if (status === '审核通过' && product) {
                    if (!processedData.product.all[product]) processedData.product.all[product] = 0;
                    processedData.product.all[product]++;
                    
                    if (category === '有源' || category === '无源') {
                        if (!processedData.product[category][product]) processedData.product[category][product] = 0;
                        processedData.product[category][product]++;
                    }
                }
            });
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const str = dateStr.toString().trim();
            
            const formats = [
                /(\d{4})-(\d{1,2})-(\d{1,2})/,
                /(\d{4})\/(\d{1,2})\/(\d{1,2})/,
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
            ];
            
            for (let format of formats) {
                const match = str.match(format);
                if (match) {
                    let year, month, day;
                    if (format === formats[2]) {
                        month = parseInt(match[1]);
                        day = parseInt(match[2]);
                        year = parseInt(match[3]);
                    } else {
                        year = parseInt(match[1]);
                        month = parseInt(match[2]);
                        day = parseInt(match[3]);
                    }
                    
                    const date = new Date(year, month - 1, day);
                    if (date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day) {
                        return date;
                    }
                }
            }
            return null;
        }
        
        function getPeriodKey(date, groupBy) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            switch(groupBy) {
                case 'month':
                    return `${month}月`;
                case 'quarter':
                    const quarter = Math.ceil(month / 3);
                    return `Q${quarter}`;
                case 'day':
                    return `${month}/${day}`;
                default:
                    return `${month}月`;
            }
        }
        
        function updateAllCharts() {
            updateStatusChart();
            updateCategoryChart();
            updateInjuryChart();
            updateReporterTable();
            updateProductTable();
        }
        
        function updateSpecificChart(chartName) {
            switch(chartName) {
                case 'status':
                    updateStatusChart();
                    break;
                case 'category':
                    updateCategoryChart();
                    break;
                case 'injury':
                    updateInjuryChart();
                    break;
            }
        }
        
        function createChart(ctx, type, data, options = {}) {
            const chartId = ctx.canvas.id;
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            
            // 设置医疗专业配色
            const colors = {
                primary: '#2E86AB',
                secondary: '#A23B72',
                success: '#28A745',
                warning: '#FFC107',
                danger: '#DC3545',
                info: '#17A2B8'
            };
            
            // 为数据添加医疗风格渐变色
            if (data.datasets) {
                data.datasets.forEach((dataset, index) => {
                    if (!dataset.backgroundColor) {
                        const colorKeys = Object.keys(colors);
                        const baseColor = colors[colorKeys[index % colorKeys.length]];
                        dataset.backgroundColor = baseColor;
                        dataset.borderColor = baseColor;
                        
                        if (type === 'line') {
                            dataset.backgroundColor = baseColor + '20'; // 透明度
                            dataset.fill = false;
                            dataset.tension = 0.4;
                        }
                    }
                });
            }
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: type === 'pie' ? 'bottom' : 'top',
                    }
                },
                scales: type === 'pie' ? {} : {
                    y: {
                        beginAtZero: true,
                        grace: '15%', // Y轴顶部留白
                        grid: {
                            color: '#e9ecef',
                            lineWidth: 1
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            };
            
            charts[chartId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {...defaultOptions, ...options},
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        if (type === 'pie') return; // 饼图不需要数值标签
                        
                        const ctx = chart.ctx;
                        ctx.save();
                        
                        chart.data.datasets.forEach(function(dataset, datasetIndex) {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            if (!meta.hidden) {
                                meta.data.forEach(function(element, index) {
                                    const value = dataset.data[index];
                                    if (value === 0) return;
                                    
                                    ctx.fillStyle = '#333';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    
                                    const position = element.tooltipPosition();
                                    
                                    // 智能标签定位 - 统一外置标签
                                    if (chart.config.options.indexAxis === 'y') {
                                        // 水平条形图 - 标签显示在条形右侧
                                        ctx.textAlign = 'left';
                                        ctx.fillText(value.toString(), position.x + 8, position.y);
                                    } else {
                                        // 垂直柱状图/折线图 - 标签显示在柱子上方
                                        ctx.fillText(value.toString(), position.x, position.y - 8);
                                    }
                                });
                            }
                        });
                        
                        ctx.restore();
                    }
                }]
            });
        }
        
        function generateSummaryText() {
            if (!currentYear) return '';
            
            // 根据当前筛选条件生成对应的小结文字
            let periodText = `${currentYear}年`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}季度`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}月`;
            } else {
                periodText += '全年';
            }
            
            // 计算当前筛选条件下的总数和各项统计
            let totalReports = 0;
            let approvedReports = 0;
            let deviceReports = 0;
            let consumableReports = 0;
            let severeInjuryReports = 0;
            
            // 统计当前筛选数据
            const statusData = processedData.status;
            const periods = Object.keys(statusData);
            
            periods.forEach(period => {
                Object.keys(statusData[period]).forEach(status => {
                    totalReports += statusData[period][status];
                    if (status === '审核通过') {
                        approvedReports += statusData[period][status];
                    }
                });
            });
            
            // 计算产品类别
            const categoryData = processedData.category;
            Object.keys(categoryData).forEach(period => {
                deviceReports += categoryData[period]['有源'] || 0;
                consumableReports += categoryData[period]['无源'] || 0;
            });
            
            // 计算严重伤害
            const injuryData = processedData.injury;
            Object.keys(injuryData).forEach(period => {
                severeInjuryReports += injuryData[period]['严重伤害'] || 0;
            });
            
            const approvedRate = totalReports > 0 ? ((approvedReports / totalReports) * 100).toFixed(1) : 0;
            const deviceRate = approvedReports > 0 ? ((deviceReports / approvedReports) * 100).toFixed(1) : 0;
            const consumableRate = approvedReports > 0 ? ((consumableReports / approvedReports) * 100).toFixed(1) : 0;
            const severeRate = approvedReports > 0 ? ((severeInjuryReports / approvedReports) * 100).toFixed(1) : 0;
            
            return `${periodText}共上报医疗器械不良事件报告${totalReports}条，其中审核通过${approvedReports}条（占${approvedRate}%），审核通过的报告中，设备（有源医疗器械）报告${deviceReports}条（占${deviceRate}%），耗材（无源医疗器械）报告${consumableReports}条（占${consumableRate}%），严重伤害报告${severeInjuryReports}条（占${severeRate}%）。`;
        }
        
        function updateStatusChart() {
            const data = processedData.status;
            const periods = Object.keys(data).sort();
            
            if (periods.length === 0) return;
            
            const statusTypes = new Set();
            periods.forEach(p => {
                Object.keys(data[p] || {}).forEach(s => statusTypes.add(s));
            });
            
            const datasets = Array.from(statusTypes).map((status, index) => ({
                label: status,
                data: periods.map(p => (data[p] && data[p][status]) || 0),
            }));
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            const chartType = chartTypes.status;
            
            let chartData;
            if (chartType === 'pie') {
                // 饼图显示总计数据
                const totals = {};
                statusTypes.forEach(status => {
                    totals[status] = periods.reduce((sum, p) => sum + ((data[p] && data[p][status]) || 0), 0);
                });
                
                chartData = {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#28A745', '#DC3545', '#FFC107', '#17A2B8']
                    }]
                };
            } else {
                chartData = {
                    labels: periods,
                    datasets: datasets
                };
            }
            
            createChart(ctx, chartType, chartData);
            
            // 更新小结文字
            document.getElementById('statusSummary').innerHTML = generateSummaryText();
        }
        
        function updateCategoryChart() {
            const data = processedData.category;
            const periods = Object.keys(data).sort();
            
            if (periods.length === 0) {
                document.getElementById('categorySummary').innerHTML = '当前筛选条件下无审核通过的数据';
                return;
            }
            
            const categoryTypes = new Set();
            periods.forEach(p => {
                Object.keys(data[p] || {}).forEach(c => categoryTypes.add(c));
            });
            
            const datasets = Array.from(categoryTypes).map((category) => ({
                label: category === '有源' ? '设备（有源）' : '耗材（无源）',
                data: periods.map(p => (data[p] && data[p][category]) || 0),
            }));
            
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const chartType = chartTypes.category;
            
            let chartData;
            if (chartType === 'pie') {
                const totals = {};
                categoryTypes.forEach(category => {
                    const label = category === '有源' ? '设备（有源）' : '耗材（无源）';
                    totals[label] = periods.reduce((sum, p) => sum + ((data[p] && data[p][category]) || 0), 0);
                });
                
                chartData = {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#17A2B8', '#FFC107']
                    }]
                };
            } else {
                chartData = {
                    labels: periods,
                    datasets: datasets
                };
            }
            
            createChart(ctx, chartType, chartData);
            
            document.getElementById('categorySummary').innerHTML = generateSummaryText();
        }
        
        function updateInjuryChart() {
            const data = processedData.injury;
            const periods = Object.keys(data).sort();
            
            if (periods.length === 0) {
                document.getElementById('injurySummary').innerHTML = '当前筛选条件下无审核通过的数据';
                return;
            }
            
            const injuryTypes = new Set();
            periods.forEach(p => {
                Object.keys(data[p] || {}).forEach(i => injuryTypes.add(i));
            });
            
            const datasets = Array.from(injuryTypes).map((injury) => ({
                label: injury,
                data: periods.map(p => (data[p] && data[p][injury]) || 0),
            }));
            
            const ctx = document.getElementById('injuryChart').getContext('2d');
            const chartType = chartTypes.injury;
            
            let chartData;
            if (chartType === 'pie') {
                const totals = {};
                injuryTypes.forEach(injury => {
                    totals[injury] = periods.reduce((sum, p) => sum + ((data[p] && data[p][injury]) || 0), 0);
                });
                
                chartData = {
                    labels: Object.keys(totals),
                    datasets: [{
                        data: Object.values(totals),
                        backgroundColor: ['#FD7E14', '#E83E8C', '#6610F2', '#20C997']
                    }]
                };
            } else {
                chartData = {
                    labels: periods,
                    datasets: datasets
                };
            }
            
            createChart(ctx, chartType, chartData);
            
            document.getElementById('injurySummary').innerHTML = generateSummaryText();
        }
        
        function updateReporterTable() {
            const data = processedData.reporter;
            const reporters = Object.entries(data)
                .sort((a, b) => b[1] - a[1]);
            
            let periodText = `${currentYear}年`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}季度`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}月`;
            } else {
                periodText += '全年';
            }
            
            let tableHtml = `
                <div style="margin-bottom: 15px;">
                    <strong>${periodText}报告人统计：</strong>共 ${reporters.length} 个报告人，总计 ${reporters.reduce((sum, r) => sum + r[1], 0)} 条报告
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>报告人</th>
                            <th>报告数量</th>
                            <th>占比</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const total = reporters.reduce((sum, r) => sum + r[1], 0);
            if (reporters.length > 0) {
                reporters.forEach((reporter, index) => {
                    const percentage = ((reporter[1] / total) * 100).toFixed(2);
                    tableHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${reporter[0]}</td>
                            <td>${reporter[1]}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            } else {
                tableHtml += `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">当前筛选条件下暂无数据</td>
                    </tr>
                `;
            }
            
            tableHtml += '</tbody></table>';
            document.getElementById('reporterStats').innerHTML = tableHtml;
        }
        
        function updateProductTable() {
            const data = processedData.product[currentCategory];
            const products = Object.entries(data)
                .sort((a, b) => b[1] - a[1]);
            
            let categoryTitle = '';
            switch(currentCategory) {
                case 'all': categoryTitle = '全部产品'; break;
                case '有源': categoryTitle = '设备（有源）'; break;
                case '无源': categoryTitle = '耗材（无源）'; break;
            }
            
            let periodText = `${currentYear}年`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}季度`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}月`;
            } else {
                periodText += '全年';
            }
            
            let tableHtml = `
                <div style="margin-bottom: 15px;">
                    <strong>${categoryTitle}统计（${periodText}）：</strong>共 ${products.length} 种产品，总计 ${products.reduce((sum, p) => sum + p[1], 0)} 条报告
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>产品名称</th>
                            <th>报告数量</th>
                            <th>占比</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const total = products.reduce((sum, p) => sum + p[1], 0);
            if (total > 0) {
                products.forEach((product, index) => {
                    const percentage = ((product[1] / total) * 100).toFixed(2);
                    tableHtml += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${product[0]}</td>
                            <td>${product[1]}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            } else {
                tableHtml += `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">当前筛选条件下暂无${categoryTitle}数据</td>
                    </tr>
                `;
            }
            
            tableHtml += '</tbody></table>';
            document.getElementById('productStats').innerHTML = tableHtml;
        }
        
        function downloadChart(chartId) {
            const chart = charts[chartId];
            if (!chart) {
                alert('图表未找到');
                return;
            }
            
            // 创建下载选项
            const options = [
                { format: 'png', label: 'PNG高清图片' },
                { format: 'pdf', label: 'PDF矢量图' },
                { format: 'jpg', label: 'JPG压缩图片' }
            ];
            
            const selection = prompt('请选择下载格式：\n1. PNG高清图片\n2. PDF矢量图\n3. JPG压缩图片\n\n请输入数字 1-3：');
            
            if (!selection || selection < 1 || selection > 3) return;
            
            const selectedOption = options[selection - 1];
            const canvas = chart.canvas;
            
            if (selectedOption.format === 'png') {
                const url = canvas.toDataURL('image/png');
                downloadFile(url, `${chartId}_${currentYear}年_${new Date().getTime()}.png`);
            } else if (selectedOption.format === 'jpg') {
                const url = canvas.toDataURL('image/jpeg', 0.9);
                downloadFile(url, `${chartId}_${currentYear}年_${new Date().getTime()}.jpg`);
            } else if (selectedOption.format === 'pdf') {
                // 简化版PDF下载（实际为PNG格式）
                const url = canvas.toDataURL('image/png');
                downloadFile(url, `${chartId}_${currentYear}年_${new Date().getTime()}.png`);
                alert('PDF格式下载功能开发中，已为您下载PNG格式');
            }
        }
        
        function downloadFile(url, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = url;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportToExcel() {
            if (rawData.length === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // 原始数据
            const ws1 = XLSX.utils.json_to_sheet(rawData);
            XLSX.utils.book_append_sheet(wb, ws1, "原始数据");
            
            // 统计汇总
            let periodText = `${currentYear}年`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}季度`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}月`;
            } else {
                periodText += '全年';
            }
            
            const summaryData = [
                ['统计项目', '数值'],
                ['分析时间', periodText],
                ['数据总条数', rawData.length],
                ['报告人总数', Object.keys(processedData.reporter).length],
                ['产品种类', Object.keys(processedData.product.all).length]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, "统计汇总");
            
            XLSX.writeFile(wb, `医疗器械不良事件统计分析_${periodText}_${new Date().getTime()}.xlsx`);
        }
        
        function exportToCSV() {
            if (rawData.length === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            const csv = Papa.unparse(rawData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            let periodText = `${currentYear}年`;
            if (currentQuarter !== 'all') {
                periodText += `${currentQuarter}季度`;
            } else if (currentMonth !== 'all') {
                periodText += `${currentMonth}月`;
            } else {
                periodText += '全年';
            }
            
            link.setAttribute('download', `医疗器械不良事件数据_${periodText}_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
